import React, { useState, useEffect } from 'react';
import { Pie, Bar, Line, Doughnut } from 'react-chartjs-2';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, PointElement, LineElement } from 'chart.js';

ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, PointElement, LineElement);

const CookieAnalyticsDashboard = () => {
  const [events, setEvents] = useState([]);

  useEffect(() => {
    const storedEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
    setEvents(storedEvents);
  }, []);

  // Process data for charts
  const consentEvents = events.filter(e => e.type === 'consent_given' || e.type === 'preferences_saved');
  const consentData = consentEvents.reduce((acc, e) => {
    if (e.consent) {
      if (e.consent.essential) acc.essential = (acc.essential || 0) + 1;
      if (e.consent.analytics) acc.analytics = (acc.analytics || 0) + 1;
      if (e.consent.marketing) acc.marketing = (acc.marketing || 0) + 1;
    }
    return acc;
  }, {});

  const interactionData = {
    bannerShown: events.filter(e => e.type === 'banner_shown').length,
    consentGiven: events.filter(e => e.type === 'consent_given' || e.type === 'preferences_saved').length,
    customizeClicked: events.filter(e => e.type === 'customize_clicked').length,
    preferencesSaved: events.filter(e => e.type === 'preferences_saved').length,
    formSubmissions: events.filter(e => e.type === 'form_submission').length,
  };

  // Sort events by timestamp
  const sortedEvents = events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

  // Cumulative data for line chart
  let cumulativeCustomize = 0;
  let cumulativeEssential = 0;
  let cumulativeAnalytics = 0;
  let cumulativeMarketing = 0;
  const cumulativeData = sortedEvents.map(e => {
    if (e.type === 'customize_clicked') cumulativeCustomize++;
    if (e.consent) {
      if (e.consent.essential) cumulativeEssential++;
      if (e.consent.analytics) cumulativeAnalytics++;
      if (e.consent.marketing) cumulativeMarketing++;
    }
    return {
      time: new Date(e.timestamp).toLocaleString(),
      customize: cumulativeCustomize,
      essential: cumulativeEssential,
      analytics: cumulativeAnalytics,
      marketing: cumulativeMarketing,
    };
  });

  const timelineData = events.reduce((acc, e) => {
    const date = new Date(e.timestamp).toLocaleDateString();
    acc[date] = (acc[date] || 0) + 1;
    return acc;
  }, {});

  const pieData = {
    labels: ['Essential Cookies', 'Analytics Cookies', 'Marketing Cookies'],
    datasets: [{
      data: [consentData.essential || 0, consentData.analytics || 0, consentData.marketing || 0],
      backgroundColor: ['#4CAF50', '#2196F3', '#FF9800'],
    }],
  };

  const interactionLabels = ['Banner Shown', 'Consent Given', 'Customize Clicked', 'Preferences Saved', 'Form Submissions'];
  const interactionValues = Object.values(interactionData);
  const filteredLabels = interactionLabels.filter((_, i) => interactionValues[i] > 0);
  const filteredData = interactionValues.filter(v => v > 0);
  const filteredColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'].slice(0, filteredLabels.length);

  const doughnutData = {
    labels: filteredLabels,
    datasets: [{
      data: filteredData,
      backgroundColor: filteredColors,
      hoverBackgroundColor: filteredColors,
    }],
  };

  const lineData = {
    labels: Object.keys(timelineData),
    datasets: [{
      label: 'Events per Day',
      data: Object.values(timelineData),
      borderColor: '#FF9800',
      fill: false,
    }],
  };

  const cumulativeLineData = {
    labels: cumulativeData.map(d => d.time),
    datasets: [
      {
        label: 'Cumulative Customize Clicked',
        data: cumulativeData.map(d => d.customize),
        borderColor: '#9C27B0',
        fill: false,
        tension: 0.1,
      },
      {
        label: 'Cumulative Essential Enabled',
        data: cumulativeData.map(d => d.essential),
        borderColor: '#4CAF50',
        fill: false,
        tension: 0.1,
      },
      {
        label: 'Cumulative Analytics Enabled',
        data: cumulativeData.map(d => d.analytics),
        borderColor: '#2196F3',
        fill: false,
        tension: 0.1,
      },
      {
        label: 'Cumulative Marketing Enabled',
        data: cumulativeData.map(d => d.marketing),
        borderColor: '#FF9800',
        fill: false,
        tension: 0.1,
      },
    ],
  };

  const totalEvents = events.length;
  const uniqueDays = new Set(events.map(e => new Date(e.timestamp).toDateString())).size;

  return (
    <div style={{ padding: '20px', fontFamily: 'Arial, sans-serif' }}>
      <h1>Cookie Analytics Dashboard</h1>
      <div style={{ display: 'flex', gap: '20px', marginBottom: '20px', flexWrap: 'wrap' }}>
        <div style={{ background: '#f0f0f0', padding: '10px', borderRadius: '8px', flex: '1 1 200px' }}>
          <h3>Total Events</h3>
          <p style={{ fontSize: '24px', margin: 0 }}>{totalEvents}</p>
        </div>
        <div style={{ background: '#f0f0f0', padding: '10px', borderRadius: '8px', flex: '1 1 200px' }}>
          <h3>Active Days</h3>
          <p style={{ fontSize: '24px', margin: 0 }}>{uniqueDays}</p>
        </div>
        <div style={{ background: '#f0f0f0', padding: '10px', borderRadius: '8px', flex: '1 1 200px' }}>
          <h3>Banner Acceptance Rate</h3>
          <p style={{ fontSize: '24px', margin: 0 }}>{interactionData.bannerShown > 0 ? Math.round((interactionData.consentGiven / interactionData.bannerShown) * 100) + '%' : 'N/A'}</p>
        </div>
      </div>
      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '20px' }}>
        <div style={{ flex: '1 1 300px' }}>
          <h2>Consent Preferences</h2>
          <Pie data={pieData} />
        </div>
        <div style={{ flex: '1 1 300px' }}>
          <h2>Interactions</h2>
          <Doughnut data={doughnutData} />
        </div>
        <div style={{ flex: '1 1 300px' }}>
          <h2>Event Timeline</h2>
          <Line data={lineData} />
        </div>
        <div style={{ flex: '1 1 600px' }}>
          <h2>Cumulative Progression</h2>
          <Line data={cumulativeLineData} />
        </div>
      </div>
      <div style={{ marginTop: '20px' }}>
        <h2>Raw Events</h2>
        <pre>{JSON.stringify(events, null, 2)}</pre>
      </div>
    </div>
  );
};

export default CookieAnalyticsDashboard;