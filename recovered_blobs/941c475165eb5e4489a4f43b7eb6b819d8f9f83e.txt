import React, { useState, useEffect } from 'react';
import { Country, State, City } from 'country-state-city';

const AddressSelector = ({ onAddressChange, onCountryChange }) => {
  const [selectedCountry, setSelectedCountry] = useState('');
  const [selectedState, setSelectedState] = useState('');
  const [selectedCity, setSelectedCity] = useState('');
  const [streetAddress, setStreetAddress] = useState('');

  const countries = Country.getAllCountries();
  const states = selectedCountry ? State.getStatesOfCountry(selectedCountry) : [];
  const cities = selectedState ? City.getCitiesOfState(selectedCountry, selectedState) : [];

  useEffect(() => {
    // Reset lower levels when higher level changes
    setSelectedState('');
    setSelectedCity('');
    onCountryChange && onCountryChange(selectedCountry);
  }, [selectedCountry, onCountryChange]);

  useEffect(() => {
    setSelectedCity('');
  }, [selectedState]);

  useEffect(() => {
    // Combine address
    const fullAddress = [streetAddress, selectedCity, selectedState, selectedCountry].filter(Boolean).join(', ');
    onAddressChange(fullAddress);
  }, [selectedCountry, selectedState, selectedCity, streetAddress, onAddressChange]);

  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', alignItems: 'end' }}>
      <label style={{ display: 'flex', flexDirection: 'column' }}>
        Country
        <select
          value={selectedCountry}
          onChange={(e) => setSelectedCountry(e.target.value)}
          required
          aria-label="Select Country"
          style={{ padding: '10px', borderRadius: '8px', border: '1px solid #e2e8f0' }}
        >
          <option value="">Select Country</option>
          {countries.map((country) => (
            <option key={country.isoCode} value={country.isoCode}>
              {country.name}
            </option>
          ))}
        </select>
      </label>

      <label style={{ display: 'flex', flexDirection: 'column' }}>
        Region/State
        <select
          value={selectedState}
          onChange={(e) => setSelectedState(e.target.value)}
          disabled={!selectedCountry}
          required
          aria-label="Select Region/State"
          style={{ padding: '10px', borderRadius: '8px', border: '1px solid #e2e8f0' }}
        >
          <option value="">Select Region/State</option>
          {states.map((state) => (
            <option key={state.isoCode} value={state.isoCode}>
              {state.name}
            </option>
          ))}
        </select>
      </label>

      <label style={{ display: 'flex', flexDirection: 'column' }}>
        City
        {cities.length > 0 ? (
          <select
            value={selectedCity}
            onChange={(e) => setSelectedCity(e.target.value)}
            disabled={!selectedState}
            required
            aria-label="Select City"
            style={{ padding: '10px', borderRadius: '8px', border: '1px solid #e2e8f0' }}
          >
            <option value="">Select City</option>
            {cities.map((city) => (
              <option key={city.name} value={city.name}>
                {city.name}
              </option>
            ))}
          </select>
        ) : (
          <input
            type="text"
            value={selectedCity}
            onChange={(e) => setSelectedCity(e.target.value)}
            placeholder="Enter City"
            disabled={!selectedState}
            required
            aria-label="Enter City"
            style={{ padding: '10px', borderRadius: '8px', border: '1px solid #e2e8f0' }}
          />
        )}
      </label>

      <label style={{ display: 'flex', flexDirection: 'column' }}>
        Street Address
        <input
          type="text"
          value={streetAddress}
          onChange={(e) => setStreetAddress(e.target.value)}
          placeholder="Street address, building, etc."
          required
          aria-label="Street Address"
          style={{ padding: '10px', borderRadius: '8px', border: '1px solid #e2e8f0' }}
        />
      </label>
    </div>
  );
};

export default AddressSelector;