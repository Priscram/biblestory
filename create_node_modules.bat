@echo off
setlocal enabledelayedexpansion

echo Creating node_modules structure from recovered blobs...

if not exist "node_modules" mkdir node_modules

REM Process package.json files to create proper node_modules structure
for /r "organized_blobs" %%f in (package.json) do (
    set "filepath=%%f"
    set "dirname=%%~dpf"
    set "dirname=!dirname:~0,-1!"

    REM Read the package name from package.json
    for /f "tokens=*" %%l in ('findstr /C:"\"name\":" "%%f"') do (
        set "line=%%l"
        REM Extract package name between quotes
        for /f "tokens=2 delims=:" %%n in ("!line!") do (
            set "pkgname=%%n"
            set "pkgname=!pkgname:"=!"
            set "pkgname=!pkgname:,=!"
            set "pkgname=!pkgname: =!"

            REM Create node_modules directory structure
            set "nodedir=node_modules\!pkgname!"
            mkdir "!nodedir!" 2>nul

            REM Copy package.json
            copy "%%f" "!nodedir!\package.json" >nul

            REM Look for associated files in the same directory
            for %%o in ("!dirname!\*") do (
                if not "%%~no"=="package" (
                    copy "%%o" "!nodedir!\%%~no%%~xo" >nul
                )
            )

            echo Created !nodedir!
        )
    )
)

REM Process SVG files - put them in appropriate flag packages
if exist "organized_blobs\flags" (
    for %%f in (organized_blobs\flags\*.svg) do (
        REM Try to determine which package this belongs to
        REM For now, put all flags in a generic flags package
        set "flagdir=node_modules\country-flag-icons"
        mkdir "!flagdir!" 2>nul
        mkdir "!flagdir!\flags" 2>nul
        copy "%%f" "!flagdir!\flags\%%~nf%%~xf" >nul
    )
)

REM Process JS export files
if exist "organized_blobs\js_exports" (
    for %%f in (organized_blobs\js_exports\*.js) do (
        REM These are likely index files for packages
        set "jsdir=node_modules\country-flag-icons"
        mkdir "!jsdir!" 2>nul
        copy "%%f" "!jsdir!\index.js" >nul
    )
)

echo.
echo node_modules structure created!
echo.
echo Directory structure:
tree node_modules /f